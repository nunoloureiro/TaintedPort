============================================================
  TaintedPort - Known Vulnerabilities
  Use this to verify the accuracy of your DAST scan results.
============================================================

#  VULNERABILITY                   LOCATION                            CWE         SEVERITY
-- -------------------------------- -----------------------------------  ----------  --------
1  SQL Injection                   POST /auth/login (email field)      CWE-89      High
2  SQL Injection                   GET /wines/:id (wine ID in URL)     CWE-89      High
3  Reflected XSS                   POST /auth/login (email in error)   CWE-79      Medium
4  Reflected XSS                   GET /wines?search= (search query)   CWE-79      Medium
5  Stored XSS                      PUT /auth/profile (name field)      CWE-79      Medium
6  Stored XSS                      POST /orders (shipping name)        CWE-79      Medium
7  JWT "none" Algorithm (API2)     Authorization header (any endpoint) CWE-345     High
8  JWT Signature Bypass (API2)    Authorization header (any endpoint) CWE-347     High
9  Directory Listing               /files/ (both hosts)                CWE-548     Medium
10 CSRF                            POST /orders (checkout)             CWE-352     Medium


DETAILED DESCRIPTIONS
=====================

1. SQL Injection - Login Email
   Endpoint: POST /auth/login
   Parameter: email (JSON body)
   File: backend/api/models/User.php -> findByEmailUnsafe()
   Description: The email value is directly concatenated into a SQL query
   without parameterized statements. An attacker can inject SQL via the
   email field to bypass authentication or extract data.
   Example: email = ' OR 1=1 --

2. SQL Injection - Wine Detail (ID)
   Endpoint: GET /wines/:id
   Parameter: id (URL path)
   File: backend/api/models/Wine.php -> getByIdUnsafe()
   Description: The wine ID is directly concatenated into a SQL query.
   The route accepts non-numeric values, allowing SQL injection.
   Example: GET /wines/1 UNION SELECT * FROM users--

3. Reflected XSS - Login Email
   Endpoint: POST /auth/login
   Parameter: email (JSON body)
   File: backend/api/controllers/AuthController.php -> login()
   Description: On failed login, the error message includes the raw email
   address: "Login failed for <email>. Please check your credentials."
   The email is not HTML-encoded, so injecting HTML/JavaScript in the
   email field will be reflected in the API response.
   Example: email = <script>alert(1)</script>

4. Reflected XSS - Wine Search
   Endpoint: GET /wines?search=<payload>
   Parameter: search (query string)
   File: backend/api/controllers/WineController.php -> index()
   Frontend: frontend/app/wines/WinesCatalog.js
   Description: The search query is returned in the API response as-is
   in a "message" field. The frontend renders this message using
   dangerouslySetInnerHTML, enabling XSS.
   Example: search=<img src=x onerror=alert(1)>

5. Stored XSS - User Name (Account Page)
   Endpoint: PUT /auth/profile
   Parameter: name (JSON body)
   File: frontend/components/Navbar.js
   Description: The user's name is stored without sanitization and
   rendered in the navigation bar using dangerouslySetInnerHTML
   ("Hi, <name>"). An attacker can set their name to a script payload
   and it will execute on every page load.
   Example: name = <img src=x onerror=alert(document.cookie)>

6. Stored XSS - Shipping Name (Checkout)
   Endpoint: POST /orders
   Parameter: shipping_address.name (JSON body)
   Frontend: frontend/app/orders/[id]/page.js
   Description: The shipping name entered during checkout is stored in
   the database and rendered on the order detail page using
   dangerouslySetInnerHTML. Anyone viewing the order details will
   have the XSS payload executed.
   Example: name = <script>alert('XSS')</script>

7. JWT "none" Algorithm Accepted (Broken Authentication)
   CWE: CWE-345 (Insufficient Verification of Data Authenticity)
   OWASP API: API2:2023 Broken Authentication
   Endpoint: Any authenticated endpoint
   Header: Authorization: Bearer <token>
   File: backend/api/config/jwt.php -> decode()
   Description: The JWT decoder checks the "alg" field in the token
   header. If alg is "none", it skips signature verification entirely
   and accepts the token payload as valid. An attacker can forge tokens
   by setting alg=none and providing arbitrary payload data.
   Example: Header={"alg":"none","typ":"JWT"}, Payload={"user_id":1,"email":"admin@example.com","exp":9999999999}

8. JWT Signature Not Verified (Broken Authentication)
   CWE: CWE-347 (Improper Verification of Cryptographic Signature)
   OWASP API: API2:2023 Broken Authentication
   Endpoint: Any authenticated endpoint
   Header: Authorization: Bearer <token>
   File: backend/api/config/jwt.php -> decode()
   Description: Even for HS256 tokens, when the signature doesn't match,
   the code only logs a warning but still accepts the token. An attacker
   can modify the payload of any JWT token (e.g., change user_id) without
   needing to know the secret key.

9. Directory Listing
   URL: https://taintedport.com/files/
   URL: https://api.taintedport.com/files/
   File: docker/nginx.conf
   Description: Nginx is configured with autoindex enabled on /files/,
   which maps to the backend source directory. This exposes all PHP
   source code, the SQLite database file, and configuration files
   including the JWT secret. An attacker can download the database
   and extract user credentials.

10. CSRF on Checkout
    Endpoint: POST /orders
    File: backend/api/index.php (CORS config)
    Description: The CORS policy reflects any Origin header back with
    Access-Control-Allow-Credentials: true. Combined with the lack of
    CSRF tokens, an attacker can create a malicious page that submits
    orders on behalf of authenticated users. If the user has items in
    their cart and visits the attacker's page, the order will be placed
    automatically.


BUSINESS LOGIC VULNERABILITIES
==============================

#  VULNERABILITY                   LOCATION                                CWE         SEVERITY
-- -------------------------------- ---------------------------------------- ----------  --------
11 BOLA (IDOR) on Order Details    GET /orders/:id                         CWE-639     High
12 BOLA / Mass Assignment          PUT /auth/profile (user_id param)       CWE-639     High
13 Price Manipulation              POST /cart/add (price param)            CWE-472     High
14 Broken Access Control on 2FA    POST /auth/2fa/disable (user_id param)  CWE-639     High
15 Discount Code Bypass            POST /orders (discount_code/percent)    CWE-472     High
16 Privilege Escalation (Register) POST /auth/register (is_admin param)    CWE-915     Critical
17 Privilege Escalation (JWT)      /admin/* (JWT claim forgery chain)      CWE-269     Critical
18 BOPLA (Data Exposure)           GET /orders/:id (leaks user secrets)    CWE-213     High
19 BFLA (Order Status)             PUT /orders/:id/status (is_admin body)  CWE-285     High


11. BOLA (IDOR) on Order Details
    Endpoint: GET /orders/:id
    File: backend/api/models/Order.php -> getById()
    Description: The order detail endpoint does not verify that the
    authenticated user owns the order. Any authenticated user can view
    any order by guessing or enumerating order IDs.

12. BOLA / Mass Assignment on Profile Update
    Endpoint: PUT /auth/profile
    Parameter: user_id (JSON body)
    File: backend/api/controllers/AuthController.php -> updateProfile()
    Description: The profile update endpoint accepts an optional user_id
    parameter. If provided, it updates that user's name instead of the
    authenticated user's name. An attacker can modify any user's profile.

13. Price Manipulation on Cart
    Endpoint: POST /cart/add
    Parameter: price (JSON body)
    File: backend/api/controllers/CartController.php -> add()
    File: backend/api/models/Cart.php -> addItem()
    Description: The cart add endpoint accepts an optional price field.
    If provided, it updates the wine's price in the database to the
    client-supplied value before adding to cart. An attacker can set
    any wine's price to 0.01 and buy it at that price.

14. Broken Access Control on 2FA Disable
    Endpoint: POST /auth/2fa/disable
    Parameter: user_id (JSON body)
    File: backend/api/controllers/AuthController.php -> disable2fa()
    Description: The 2FA disable endpoint accepts an optional user_id
    parameter. If provided, it disables 2FA for that user instead of
    the authenticated user. An attacker can disable any user's 2FA
    by providing their user_id (only needs their own valid password).

15. Discount Code Bypass
    Endpoint: POST /orders
    Parameters: discount_code, discount_percent (JSON body)
    File: backend/api/controllers/OrderController.php -> create()
    File: backend/api/models/Order.php -> create()
    Description: The checkout endpoint accepts discount_code and
    discount_percent fields. Any non-empty discount_code is accepted
    as valid, and discount_percent is applied directly without validation.
    An attacker can send discount_percent=100 for a free order, or
    even negative values for credit.


16. Privilege Escalation via Mass Assignment on Registration
    CWE: CWE-915 (Improperly Controlled Modification of Dynamically-Determined Object Attributes)
    Severity: CRITICAL
    Endpoint: POST /auth/register
    Parameter: is_admin (JSON body)
    File: backend/api/controllers/AuthController.php -> register()
    File: backend/api/models/User.php -> create()
    Description: The registration endpoint accepts an optional is_admin field
    in the request body. If is_admin=1 is sent, the new account is created
    with admin privileges. The frontend signup form does not include this field,
    but an attacker can add it via an intercepting proxy or curl.

17. Privilege Escalation via JWT Claim Forgery (Vulnerability Chain)
    CWE: CWE-269 (Improper Privilege Management), CWE-345 (Insufficient Verification of Data Authenticity)
    Severity: CRITICAL
    Endpoint: All /admin/* endpoints
    File: backend/api/controllers/AdminController.php -> requireAdmin()
    File: backend/api/config/jwt.php -> decode()
    Description: The admin authorization check reads the is_admin flag from
    the JWT token payload instead of the database. Combined with the existing
    JWT vulnerabilities (#7 "none" algorithm or #8 signature bypass), an
    attacker can forge a JWT token with is_admin=true to gain admin access.
    Steps: (1) Login as any user â†’ get a JWT token, (2) Decode the JWT
    payload, (3) Modify is_admin to true, (4) Re-encode with alg=none or
    any signature, (5) Use the forged token to access /admin/* endpoints.


18. BOPLA - Excessive Data Exposure on Order Details
    CWE: CWE-213 (Exposure of Sensitive Information Due to Incompatible Policies)
    OWASP API: API3:2023 Broken Object Property Level Authorization
    Severity: HIGH
    Endpoint: GET /orders/:id
    File: backend/api/models/Order.php -> getById()
    Description: The order detail endpoint JOINs with the users table and
    returns sensitive user properties in the response: password_hash,
    totp_secret (2FA seed), is_admin flag, and email of the order owner.
    Combined with the existing BOLA (#11), any authenticated user can
    retrieve any order and get the order owner's hashed password and
    2FA secret, enabling offline password cracking and 2FA bypass.

19. BFLA - Broken Function Level Authorization on Order Status Update
    CWE: CWE-285 (Improper Authorization)
    OWASP API: API5:2023 Broken Function Level Authorization
    Severity: HIGH
    Endpoint: PUT /orders/:id/status
    Parameter: is_admin (JSON body, set to true)
    File: backend/api/controllers/OrderController.php -> updateStatus()
    Description: There is a separate (non-admin) endpoint for updating
    order status. Instead of verifying the user's actual role from the
    database or JWT, it checks if is_admin=true was passed in the
    request body. Any authenticated user can change any order's status
    (pending, processing, shipped, delivered, cancelled) by simply
    including "is_admin": true in their request.


NOTES FOR TESTERS
=================

- Default credentials:
    joe@example.com / password123 (user id: 1, has 2 pre-seeded orders)
    jane@example.com / password123 (user id: 2, has 3 pre-seeded orders)
    admin@example.com / password123 (user id: 3, admin role, access to /admin)
- The database resets weekly (Monday 00:00 UTC) or on container restart.
- JWT secret is: pTg7Kz9mQxR4vL2wN8jF5dY1hA6cB3eS0uI (also visible via directory listing)
- The frontend is at https://taintedport.com
- The API is at https://api.taintedport.com
- For local Docker: http://localhost:8080 (frontend) and http://localhost:8080/api/ (API)
