worker_processes auto;
pid /var/run/nginx/nginx.pid;
error_log /dev/stderr warn;

events {
    worker_connections 256;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;

    sendfile    on;
    tcp_nopush  on;

    keepalive_timeout 65;

    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # =========================================================
    # Production: api.taintedport.com -> PHP API
    # =========================================================
    server {
        listen 80;
        server_name api.taintedport.com;

        # VULN: Directory listing enabled on /files/
        location /files/ {
            alias /var/www/backend/;
            autoindex on;
            autoindex_format html;
        }

        location / {
            fastcgi_pass unix:/var/run/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www/backend/api/index.php;
            fastcgi_param REQUEST_URI $request_uri;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param SERVER_NAME $server_name;
            fastcgi_param SERVER_PORT $server_port;
            fastcgi_param SERVER_PROTOCOL $server_protocol;
            fastcgi_param HTTPS $https if_not_empty;
            fastcgi_param HTTP_AUTHORIZATION $http_authorization;
            fastcgi_param HTTP_ORIGIN $http_origin;
            include fastcgi_params;
        }
    }

    # =========================================================
    # VULN: Directory listing on /files/ path
    # =========================================================
    # =========================================================
    # Production: taintedport.com -> Next.js frontend
    # Also: default server for local Docker (localhost:8080)
    # =========================================================
    server {
        listen 80 default_server;
        server_name taintedport.com _;

        # VULN: Directory listing enabled on /files/
        location /files/ {
            alias /var/www/backend/;
            autoindex on;
            autoindex_format html;
        }

        # --- /api/* path-based routing (for local Docker) ---
        location /api/ {
            fastcgi_pass unix:/var/run/php-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www/backend/api/index.php;
            fastcgi_param REQUEST_URI $request_uri;
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param CONTENT_TYPE $content_type;
            fastcgi_param CONTENT_LENGTH $content_length;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_param SERVER_NAME $server_name;
            fastcgi_param SERVER_PORT $server_port;
            fastcgi_param SERVER_PROTOCOL $server_protocol;
            fastcgi_param HTTPS $https if_not_empty;
            fastcgi_param HTTP_AUTHORIZATION $http_authorization;
            fastcgi_param HTTP_ORIGIN $http_origin;
            include fastcgi_params;
        }

        # --- Next.js static assets ---
        location /_next/static/ {
            alias /var/www/frontend/.next/static/;
            expires 365d;
            add_header Cache-Control "public, immutable";
        }

        # --- Public static files ---
        location /public/ {
            alias /var/www/frontend/public/;
            expires 7d;
        }

        # --- Everything else: Next.js app ---
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
